<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title><%= recipe.title %></title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <p><button onclick="window.location.href='/recipes'">Back to Recipes</button></p>
  <h1><%= recipe.title %></h1>
  <% if (recipe.image_url) { %>
    <p><img src="<%= recipe.image_url %>" alt="<%= recipe.title %>" style="max-width: 480px; height:auto" /></p>
  <% } %>

  <h3>Ingredients</h3>
  <pre><%= recipe.ingredients %></pre>

  <h3>Instructions</h3>
  <pre><%= recipe.instructions %></pre>

  <p>
    <% if (recipe.cuisine) { %>Cuisine: <%= recipe.cuisine %> • <% } %>
    <% if (recipe.difficulty) { %>Difficulty: <%= recipe.difficulty %> • <% } %>
    <% if (recipe.cook_time) { %>Cook time: <%= recipe.cook_time %> <% } %>
  </p>

  <section class="rating-section">
  <h2>Rate this recipe</h2>

  <p>
    Average rating:
    <strong><%= (typeof recipe.avg_rating !== 'undefined' && recipe.avg_rating !== null) ? recipe.avg_rating : 'N/A' %></strong>
    (<%= recipe.rating_count || 0 %> rating<%= (recipe.rating_count || 0) === 1 ? '' : 's' %>)
  </p>

  <div class="rating-widget"
       data-recipe-id="<%= recipe.id %>"
       aria-label="Rate this recipe">

    <div class="rating-stars"
         role="radiogroup"
         aria-label="Recipe rating from 1 to 5 stars">
      <% for (let i = 1; i <= 5; i++) { %>
        <button
          type="button"
          class="rating-star"
          data-value="<%= i %>"
          aria-label="<%= i %> star<%= i > 1 ? 's' : '' %>"
          aria-pressed="false">
          ★
        </button>
      <% } %>
    </div>

    <p class="rating-current">
      Selected rating:
      <span class="rating-value">None</span>
    </p>

    <button type="button"
            class="rating-submit">
      Submit rating
    </button>

    <p class="rating-message"></p>
  </div>
  </section>
 
  <script>
  document.addEventListener( 'DOMContentLoaded', () => {
  const widget = document.querySelector( '.rating-widget' );
  if ( !widget ) return;

  const stars = widget.querySelectorAll( '.rating-star' );
  const valueSpan = widget.querySelector( '.rating-value' );
  const messageP = widget.querySelector( '.rating-message' );
  const submitBtn = widget.querySelector( '.rating-submit' );
  const recipeId = widget.dataset.recipeId;

  let selectedRating = <%= typeof user_rating !== 'undefined' && user_rating ? user_rating : 0 %>;

  function updateVisual( rating ) {
    stars.forEach( star => {
      const starValue = Number( star.dataset.value );
      if ( starValue <= rating ) {
        star.classList.add( 'active' );
        star.classList.remove( 'inactive' );
        star.setAttribute( 'aria-pressed', 'true' );
      } else {
        star.classList.remove( 'active' );
        star.classList.add( 'inactive' );
        star.setAttribute( 'aria-pressed', 'false' );
      }
    } );

    if ( rating === 0 ) {
      valueSpan.textContent = 'None';
    } else {
      valueSpan.textContent = rating + ' / 5';
    }
  }

  stars.forEach( star => {
    const starValue = Number( star.dataset.value );

    star.addEventListener( 'click', () => {
      selectedRating = starValue;
      updateVisual( selectedRating );
      messageP.textContent = '';
    } );

    star.addEventListener( 'mouseenter', () => {
      updateVisual( starValue );
    } );

    star.addEventListener( 'mouseleave', () => {
      updateVisual( selectedRating );
    } );
  } );

  submitBtn.addEventListener( 'click', async () => {
    if ( selectedRating === 0 ) {
      messageP.textContent = 'Please select a rating first.';
      messageP.style.color = 'red';
      return;
    }

    try {
      const resp = await fetch(`/recipes/${recipeId}/rate`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ rating: selectedRating })
      });
      const data = await resp.json();
      if (!data.ok) {
        messageP.textContent = data.error || 'Failed to submit rating.';
        messageP.style.color = 'red';
        return;
      }
      messageP.textContent = `Thanks! Your rating of ${selectedRating} was recorded. Avg: ${data.avg_rating} (${data.rating_count} ratings)`;
      messageP.style.color = 'green';
    } catch (e) {
      messageP.textContent = 'Network error submitting rating.';
      messageP.style.color = 'red';
    }
  } );

  // initialize all stars as inactive
  updateVisual( selectedRating );
  } );
  </script>

</body>
</html>
